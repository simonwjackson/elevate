#!/usr/bin/env bash

set -euo pipefail

source ./log.sh
source ./utils.sh
source ./calculate.sh
source ./display.sh
source ./network.sh
source ./moonlight_session.sh
source ./cli.sh

export LOG_LEVEL=2

declare -A CONFIG
initialize_config() {
  CONFIG=(
    [max_resolution]="1920x1080"
    [min_resolution]="256x256"
    [max_fps]=0
    [min_fps]=24
    [available_bitrate]=0
    [prioritize]="fps"
    [latency]=0
    [max_latency]=0
    [scaling_steps]=128
    [host]=""
    [app]=""
    [log_file]="/tmp/moonbeam.log"
    [extra_moonlight_options]=""
    [dry_run]="${DRY_RUN:=false}"
    [reconnect]=false
    [max_resolution_set]=false
    [min_resolution_set]=false
    [resolution_set]=false
    [shorthand_res_set]=false
    [max_fps_set]=false
    [min_fps_set]=false
  )
}

main() {
  initialize_config
  parse_args "$@"
  apply_display_limits
  run_moonlight_session CONFIG
}

# Only run the main function if the script is being executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
